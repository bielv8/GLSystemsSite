{% extends "base.html" %}

{% block title %}Demo: Gestão de Academia - G&L Systems{% endblock %}

{% block content %}
<div class="container py-5 mt-5">
    <!-- Demo Header -->
    <div class="text-center mb-4">
        <h1><i class="fas fa-dumbbell text-success me-2"></i>Demo: Gestão de Academia</h1>
        <p class="lead text-muted">Sistema completo para academias e escolas com controle de alunos e matrículas</p>
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Esta é uma demonstração funcional. Experimente cadastrar alunos e acompanhar frequência e desempenho!
        </div>
    </div>

    <!-- Dashboard Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h4 id="totalAlunos">0</h4>
                    <p class="mb-0">Alunos Matriculados</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-check fa-2x mb-2"></i>
                    <h4 id="presencasHoje">0</h4>
                    <p class="mb-0">Presenças Hoje</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                    <h4 id="receitaMensal">R$ 0,00</h4>
                    <p class="mb-0">Receita Mensal</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                    <h4 id="taxaFrequencia">0%</h4>
                    <p class="mb-0">Taxa de Frequência</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="card shadow-sm">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="alunos-tab" data-bs-toggle="tab" data-bs-target="#alunos" type="button">
                        <i class="fas fa-users me-2"></i>Alunos
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="matriculas-tab" data-bs-toggle="tab" data-bs-target="#matriculas" type="button">
                        <i class="fas fa-id-card me-2"></i>Matrículas
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="frequencia-tab" data-bs-toggle="tab" data-bs-target="#frequencia" type="button">
                        <i class="fas fa-calendar-alt me-2"></i>Frequência
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="relatorios-tab" data-bs-toggle="tab" data-bs-target="#relatorios" type="button">
                        <i class="fas fa-chart-bar me-2"></i>Relatórios
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="card-body">
            <div class="tab-content">
                <!-- Alunos Tab -->
                <div class="tab-pane fade show active" id="alunos" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Cadastro de Alunos</h5>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#novoAlunoModal">
                            <i class="fas fa-plus me-2"></i>Novo Aluno
                        </button>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="buscarAluno" placeholder="Buscar aluno...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filtroPlano">
                                <option value="">Todos os planos</option>
                                <option value="Mensal">Mensal</option>
                                <option value="Trimestral">Trimestral</option>
                                <option value="Anual">Anual</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filtroStatus">
                                <option value="">Todos os status</option>
                                <option value="Ativo">Ativo</option>
                                <option value="Inativo">Inativo</option>
                                <option value="Suspenso">Suspenso</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary w-100" onclick="filtrarAlunos()">
                                <i class="fas fa-filter"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped" id="alunosTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>Plano</th>
                                    <th>Vencimento</th>
                                    <th>Status</th>
                                    <th>Última Presença</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Alunos data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Matrículas Tab -->
                <div class="tab-pane fade" id="matriculas" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Controle de Matrículas</h5>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novaMatriculaModal">
                            <i class="fas fa-plus me-2"></i>Nova Matrícula
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped" id="matriculasTable">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Aluno</th>
                                    <th>Plano</th>
                                    <th>Data Início</th>
                                    <th>Data Vencimento</th>
                                    <th>Valor</th>
                                    <th>Status Pagamento</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Matrículas data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Frequência Tab -->
                <div class="tab-pane fade" id="frequencia" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Registrar Frequência</h5>
                                <div>
                                    <input type="date" id="dataFrequencia" class="form-control d-inline-block" style="width: auto;">
                                    <button class="btn btn-success ms-2" onclick="registrarPresenca()">
                                        <i class="fas fa-plus me-2"></i>Registrar Presença
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="alunoFrequencia" class="form-label">Selecionar Aluno</label>
                                            <select class="form-select" id="alunoFrequencia">
                                                <option value="">Selecione um aluno</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="horaEntrada" class="form-label">Horário de Entrada</label>
                                            <input type="time" class="form-control" id="horaEntrada">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="modalidadeFrequencia" class="form-label">Modalidade</label>
                                            <select class="form-select" id="modalidadeFrequencia">
                                                <option value="">Selecione</option>
                                                <option value="Musculação">Musculação</option>
                                                <option value="Cardio">Cardio</option>
                                                <option value="Pilates">Pilates</option>
                                                <option value="Yoga">Yoga</option>
                                                <option value="Zumba">Zumba</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="horaSaida" class="form-label">Horário de Saída</label>
                                            <input type="time" class="form-control" id="horaSaida">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <h6>Presenças de Hoje</h6>
                            <div id="presencasHoje" class="list-group" style="max-height: 400px; overflow-y: auto;">
                                <!-- Presenças will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Relatórios Tab -->
                <div class="tab-pane fade" id="relatorios" role="tabpanel">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Frequência por Modalidade</h5>
                            <canvas id="modalidadeChart" width="400" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h5>Frequência Semanal</h5>
                            <canvas id="frequenciaSemanalChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Distribuição de Planos</h5>
                            <canvas id="planosChart" width="400" height="300"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h5>Receita Mensal</h5>
                            <canvas id="receitaChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button class="btn btn-success me-2" onclick="exportarFrequencia()">
                            <i class="fas fa-file-excel me-2"></i>Exportar Frequência
                        </button>
                        <button class="btn btn-info me-2" onclick="gerarRelatorioDesempenho()">
                            <i class="fas fa-chart-line me-2"></i>Relatório de Desempenho
                        </button>
                        <button class="btn btn-warning" onclick="gerarRelatorioPagamentos()">
                            <i class="fas fa-money-bill me-2"></i>Relatório de Pagamentos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Solutions -->
    <div class="text-center mt-4">
        <a href="{{ url_for('solutions') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar às Soluções
        </a>
    </div>
</div>

<!-- Novo Aluno Modal -->
<div class="modal fade" id="novoAlunoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Aluno</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="novoAlunoForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="alunoNome" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="alunoNome" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="alunoNascimento" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="alunoNascimento" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="alunoTelefone" class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="alunoTelefone" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="alunoEmail" class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="alunoEmail">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="alunoSexo" class="form-label">Sexo</label>
                            <select class="form-select" id="alunoSexo" required>
                                <option value="">Selecione</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="alunoEmergencia" class="form-label">Contato de Emergência</label>
                            <input type="tel" class="form-control" id="alunoEmergencia">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="alunoObjetivo" class="form-label">Objetivo</label>
                        <select class="form-select" id="alunoObjetivo">
                            <option value="">Selecione</option>
                            <option value="Perda de Peso">Perda de Peso</option>
                            <option value="Ganho de Massa">Ganho de Massa</option>
                            <option value="Condicionamento">Condicionamento</option>
                            <option value="Reabilitação">Reabilitação</option>
                            <option value="Bem-estar">Bem-estar</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="alunoObservacoes" class="form-label">Observações Médicas</label>
                        <textarea class="form-control" id="alunoObservacoes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="cadastrarAluno()">Cadastrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Nova Matrícula Modal -->
<div class="modal fade" id="novaMatriculaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Matrícula</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="novaMatriculaForm">
                    <div class="mb-3">
                        <label for="matriculaAluno" class="form-label">Aluno</label>
                        <select class="form-select" id="matriculaAluno" required>
                            <option value="">Selecione um aluno</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="matriculaPlano" class="form-label">Plano</label>
                            <select class="form-select" id="matriculaPlano" required onchange="calcularVencimento()">
                                <option value="">Selecione</option>
                                <option value="Mensal" data-valor="89.90" data-dias="30">Mensal - R$ 89,90</option>
                                <option value="Trimestral" data-valor="239.90" data-dias="90">Trimestral - R$ 239,90</option>
                                <option value="Semestral" data-valor="449.90" data-dias="180">Semestral - R$ 449,90</option>
                                <option value="Anual" data-valor="799.90" data-dias="365">Anual - R$ 799,90</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="matriculaValor" class="form-label">Valor (R$)</label>
                            <input type="number" class="form-control" id="matriculaValor" step="0.01" readonly>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="matriculaInicio" class="form-label">Data de Início</label>
                            <input type="date" class="form-control" id="matriculaInicio" required onchange="calcularVencimento()">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="matriculaVencimento" class="form-label">Data de Vencimento</label>
                            <input type="date" class="form-control" id="matriculaVencimento" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="matriculaPagamento" class="form-label">Forma de Pagamento</label>
                        <select class="form-select" id="matriculaPagamento" required>
                            <option value="">Selecione</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                            <option value="Cartão de Débito">Cartão de Débito</option>
                            <option value="PIX">PIX</option>
                            <option value="Boleto">Boleto</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="criarMatricula()">Criar Matrícula</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize Academia Demo
let alunos = [
    {id: 1, nome: "João Silva", nascimento: "1990-05-15", telefone: "(11) 99999-1111", email: "joao@email.com", sexo: "Masculino", objetivo: "Ganho de Massa", status: "Ativo", plano: "Mensal", vencimento: "2025-02-15", ultimaPresenca: "2025-01-18"},
    {id: 2, nome: "Maria Santos", nascimento: "1985-08-22", telefone: "(11) 99999-2222", email: "maria@email.com", sexo: "Feminino", objetivo: "Perda de Peso", status: "Ativo", plano: "Trimestral", vencimento: "2025-03-20", ultimaPresenca: "2025-01-17"},
    {id: 3, nome: "Pedro Costa", nascimento: "1992-11-10", telefone: "(11) 99999-3333", email: "pedro@email.com", sexo: "Masculino", objetivo: "Condicionamento", status: "Ativo", plano: "Anual", vencimento: "2025-12-01", ultimaPresenca: "2025-01-16"}
];

let matriculas = [
    {id: 1, numero: "MAT-001", alunoId: 1, plano: "Mensal", valor: 89.90, inicio: "2025-01-15", vencimento: "2025-02-15", pagamento: "PIX", statusPagamento: "Pago"},
    {id: 2, numero: "MAT-002", alunoId: 2, plano: "Trimestral", valor: 239.90, inicio: "2024-12-20", vencimento: "2025-03-20", pagamento: "Cartão de Crédito", statusPagamento: "Pago"},
    {id: 3, numero: "MAT-003", alunoId: 3, plano: "Anual", valor: 799.90, inicio: "2024-12-01", vencimento: "2025-12-01", pagamento: "Boleto", statusPagamento: "Pago"}
];

let frequencias = [
    {id: 1, alunoId: 1, data: "2025-01-18", entrada: "07:30", saida: "08:45", modalidade: "Musculação"},
    {id: 2, alunoId: 2, data: "2025-01-18", entrada: "18:00", saida: "19:30", modalidade: "Cardio"},
    {id: 3, alunoId: 1, data: "2025-01-17", entrada: "07:30", saida: "08:30", modalidade: "Musculação"},
    {id: 2, alunoId: 3, data: "2025-01-17", entrada: "19:00", saida: "20:15", modalidade: "Pilates"}
];

let nextAlunoId = 4;
let nextMatriculaId = 4;
let nextFrequenciaId = 5;

document.addEventListener('DOMContentLoaded', function() {
    updateDashboard();
    updateAlunosTable();
    updateMatriculasTable();
    updateAlunoSelects();
    updatePresencasHoje();
    initCharts();
    
    // Set today's date
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('dataFrequencia').value = hoje;
    document.getElementById('matriculaInicio').value = hoje;
    
    // Set current time
    const agora = new Date();
    document.getElementById('horaEntrada').value = agora.toTimeString().slice(0,5);
});

function updateDashboard() {
    const totalAlunos = alunos.filter(a => a.status === 'Ativo').length;
    const hoje = new Date().toISOString().split('T')[0];
    const presencasHoje = frequencias.filter(f => f.data === hoje).length;
    const receitaMensal = matriculas.filter(m => m.statusPagamento === 'Pago')
                                   .reduce((sum, m) => sum + m.valor, 0);
    
    // Calculate frequency rate
    const totalPossiveisPresencas = totalAlunos * 30; // Assuming 30 days per month
    const totalPresencasMes = frequencias.length;
    const taxaFrequencia = totalPossiveisPresencas > 0 ? (totalPresencasMes / totalPossiveisPresencas * 100) : 0;
    
    document.getElementById('totalAlunos').textContent = totalAlunos;
    document.getElementById('presencasHoje').textContent = presencasHoje;
    document.getElementById('receitaMensal').textContent = `R$ ${receitaMensal.toFixed(2)}`;
    document.getElementById('taxaFrequencia').textContent = `${taxaFrequencia.toFixed(1)}%`;
}

function cadastrarAluno() {
    const nome = document.getElementById('alunoNome').value;
    const nascimento = document.getElementById('alunoNascimento').value;
    const telefone = document.getElementById('alunoTelefone').value;
    const email = document.getElementById('alunoEmail').value;
    const sexo = document.getElementById('alunoSexo').value;
    const emergencia = document.getElementById('alunoEmergencia').value;
    const objetivo = document.getElementById('alunoObjetivo').value;
    const observacoes = document.getElementById('alunoObservacoes').value;
    
    const novoAluno = {
        id: nextAlunoId++,
        nome: nome,
        nascimento: nascimento,
        telefone: telefone,
        email: email,
        sexo: sexo,
        emergencia: emergencia,
        objetivo: objetivo,
        observacoes: observacoes,
        status: 'Inativo',
        plano: '',
        vencimento: '',
        ultimaPresenca: ''
    };
    
    alunos.push(novoAluno);
    updateAlunosTable();
    updateAlunoSelects();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('novoAlunoModal'));
    modal.hide();
    document.getElementById('novoAlunoForm').reset();
    
    showNotification('Aluno cadastrado com sucesso! Agora você pode criar uma matrícula.', 'success');
}

function calcularVencimento() {
    const planoSelect = document.getElementById('matriculaPlano');
    const inicioInput = document.getElementById('matriculaInicio');
    const vencimentoInput = document.getElementById('matriculaVencimento');
    const valorInput = document.getElementById('matriculaValor');
    
    const selectedOption = planoSelect.selectedOptions[0];
    if (selectedOption && inicioInput.value) {
        const valor = selectedOption.dataset.valor;
        const dias = parseInt(selectedOption.dataset.dias);
        
        valorInput.value = valor;
        
        const dataInicio = new Date(inicioInput.value);
        const dataVencimento = new Date(dataInicio);
        dataVencimento.setDate(dataVencimento.getDate() + dias);
        
        vencimentoInput.value = dataVencimento.toISOString().split('T')[0];
    }
}

function criarMatricula() {
    const alunoId = parseInt(document.getElementById('matriculaAluno').value);
    const plano = document.getElementById('matriculaPlano').value;
    const valor = parseFloat(document.getElementById('matriculaValor').value);
    const inicio = document.getElementById('matriculaInicio').value;
    const vencimento = document.getElementById('matriculaVencimento').value;
    const pagamento = document.getElementById('matriculaPagamento').value;
    
    const novaMatricula = {
        id: nextMatriculaId,
        numero: `MAT-${String(nextMatriculaId).padStart(3, '0')}`,
        alunoId: alunoId,
        plano: plano,
        valor: valor,
        inicio: inicio,
        vencimento: vencimento,
        pagamento: pagamento,
        statusPagamento: 'Pago'
    };
    
    nextMatriculaId++;
    matriculas.push(novaMatricula);
    
    // Update aluno status
    const aluno = alunos.find(a => a.id === alunoId);
    if (aluno) {
        aluno.status = 'Ativo';
        aluno.plano = plano;
        aluno.vencimento = vencimento;
    }
    
    updateDashboard();
    updateAlunosTable();
    updateMatriculasTable();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('novaMatriculaModal'));
    modal.hide();
    document.getElementById('novaMatriculaForm').reset();
    
    showNotification(`Matrícula ${novaMatricula.numero} criada com sucesso!`, 'success');
}

function registrarPresenca() {
    const alunoId = parseInt(document.getElementById('alunoFrequencia').value);
    const data = document.getElementById('dataFrequencia').value;
    const entrada = document.getElementById('horaEntrada').value;
    const saida = document.getElementById('horaSaida').value;
    const modalidade = document.getElementById('modalidadeFrequencia').value;
    
    if (!alunoId || !data || !entrada || !modalidade) {
        showNotification('Preencha todos os campos obrigatórios!', 'warning');
        return;
    }
    
    const novaFrequencia = {
        id: nextFrequenciaId++,
        alunoId: alunoId,
        data: data,
        entrada: entrada,
        saida: saida || '',
        modalidade: modalidade
    };
    
    frequencias.push(novaFrequencia);
    
    // Update aluno's last presence
    const aluno = alunos.find(a => a.id === alunoId);
    if (aluno) {
        aluno.ultimaPresenca = data;
    }
    
    updateDashboard();
    updateAlunosTable();
    updatePresencasHoje();
    initCharts();
    
    // Reset form
    document.getElementById('alunoFrequencia').value = '';
    document.getElementById('horaSaida').value = '';
    document.getElementById('modalidadeFrequencia').value = '';
    
    showNotification('Presença registrada com sucesso!', 'success');
}

function updateAlunosTable() {
    const tbody = document.querySelector('#alunosTable tbody');
    tbody.innerHTML = '';
    
    alunos.forEach(aluno => {
        const statusClass = aluno.status === 'Ativo' ? 'success' : 
                           aluno.status === 'Suspenso' ? 'warning' : 'secondary';
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${aluno.id}</td>
            <td>${aluno.nome}</td>
            <td>${aluno.telefone}</td>
            <td><span class="badge bg-info">${aluno.plano || 'Sem plano'}</span></td>
            <td>${aluno.vencimento ? new Date(aluno.vencimento).toLocaleDateString('pt-BR') : '-'}</td>
            <td><span class="badge bg-${statusClass}">${aluno.status}</span></td>
            <td>${aluno.ultimaPresenca ? new Date(aluno.ultimaPresenca).toLocaleDateString('pt-BR') : 'Nunca'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editarAluno(${aluno.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="novaMatriculaAluno(${aluno.id})">
                    <i class="fas fa-id-card"></i>
                </button>
            </td>
        `;
    });
}

function updateMatriculasTable() {
    const tbody = document.querySelector('#matriculasTable tbody');
    tbody.innerHTML = '';
    
    matriculas.forEach(matricula => {
        const aluno = alunos.find(a => a.id === matricula.alunoId);
        const statusClass = matricula.statusPagamento === 'Pago' ? 'success' : 'warning';
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${matricula.numero}</td>
            <td>${aluno?.nome || 'Aluno não encontrado'}</td>
            <td><span class="badge bg-secondary">${matricula.plano}</span></td>
            <td>${new Date(matricula.inicio).toLocaleDateString('pt-BR')}</td>
            <td>${new Date(matricula.vencimento).toLocaleDateString('pt-BR')}</td>
            <td>R$ ${matricula.valor.toFixed(2)}</td>
            <td><span class="badge bg-${statusClass}">${matricula.statusPagamento}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editarMatricula(${matricula.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="renovarMatricula(${matricula.id})">
                    <i class="fas fa-redo"></i>
                </button>
            </td>
        `;
    });
}

function updateAlunoSelects() {
    const selects = ['alunoFrequencia', 'matriculaAluno'];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Selecione um aluno</option>';
        
        alunos.forEach(aluno => {
            const option = document.createElement('option');
            option.value = aluno.id;
            option.textContent = aluno.nome;
            select.appendChild(option);
        });
    });
}

function updatePresencasHoje() {
    const hoje = new Date().toISOString().split('T')[0];
    const presencasHoje = frequencias.filter(f => f.data === hoje);
    const container = document.getElementById('presencasHoje');
    
    if (presencasHoje.length === 0) {
        container.innerHTML = '<p class="text-muted">Nenhuma presença registrada hoje.</p>';
        return;
    }
    
    let html = '';
    presencasHoje.forEach(presenca => {
        const aluno = alunos.find(a => a.id === presenca.alunoId);
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${aluno?.nome || 'Aluno não encontrado'}</h6>
                        <p class="mb-1 small">${presenca.modalidade}</p>
                        <small>${presenca.entrada}${presenca.saida ? ' - ' + presenca.saida : ''}</small>
                    </div>
                    <span class="badge bg-success">Presente</span>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function filtrarAlunos() {
    showNotification('Filtros aplicados com sucesso!', 'info');
}

function editarAluno(id) {
    showNotification('Funcionalidade de edição em desenvolvimento!', 'info');
}

function editarMatricula(id) {
    showNotification('Funcionalidade de edição em desenvolvimento!', 'info');
}

function renovarMatricula(id) {
    showNotification('Funcionalidade de renovação em desenvolvimento!', 'info');
}

function novaMatriculaAluno(alunoId) {
    document.getElementById('matriculaAluno').value = alunoId;
    const modal = new bootstrap.Modal(document.getElementById('novaMatriculaModal'));
    modal.show();
}

function initCharts() {
    // Modalidade Chart
    const ctxModalidade = document.getElementById('modalidadeChart').getContext('2d');
    const modalidades = ['Musculação', 'Cardio', 'Pilates', 'Yoga', 'Zumba'];
    const dadosModalidade = modalidades.map(mod => 
        frequencias.filter(f => f.modalidade === mod).length
    );
    
    new Chart(ctxModalidade, {
        type: 'bar',
        data: {
            labels: modalidades,
            datasets: [{
                label: 'Frequência',
                data: dadosModalidade,
                backgroundColor: '#28a745'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Frequência Semanal Chart
    const ctxSemanal = document.getElementById('frequenciaSemanalChart').getContext('2d');
    const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
    const frequenciaSemanal = [5, 15, 18, 16, 20, 22, 8];
    
    new Chart(ctxSemanal, {
        type: 'line',
        data: {
            labels: diasSemana,
            datasets: [{
                label: 'Presenças',
                data: frequenciaSemanal,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Planos Chart
    const ctxPlanos = document.getElementById('planosChart').getContext('2d');
    const planos = ['Mensal', 'Trimestral', 'Semestral', 'Anual'];
    const dadosPlanos = planos.map(plano => 
        alunos.filter(a => a.plano === plano).length
    );
    
    new Chart(ctxPlanos, {
        type: 'doughnut',
        data: {
            labels: planos,
            datasets: [{
                data: dadosPlanos,
                backgroundColor: ['#ffc107', '#17a2b8', '#28a745', '#dc3545']
            }]
        },
        options: {
            responsive: true
        }
    });
    
    // Receita Chart
    const ctxReceita = document.getElementById('receitaChart').getContext('2d');
    const meses = ['Ago', 'Set', 'Out', 'Nov', 'Dez', 'Jan'];
    const receitaMensal = [8500, 9200, 9800, 10500, 11200, 12800];
    
    new Chart(ctxReceita, {
        type: 'bar',
        data: {
            labels: meses,
            datasets: [{
                label: 'Receita (R$)',
                data: receitaMensal,
                backgroundColor: '#28a745'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function exportarFrequencia() {
    const csv = 'Data,Aluno,Modalidade,Entrada,Saída\n' +
        frequencias.map(f => {
            const aluno = alunos.find(a => a.id === f.alunoId);
            return `${f.data},${aluno?.nome},${f.modalidade},${f.entrada},${f.saida}`;
        }).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'frequencia_academia.csv';
    link.click();
    
    showNotification('Relatório de frequência exportado com sucesso!', 'success');
}

function gerarRelatorioDesempenho() {
    const totalAlunos = alunos.length;
    const alunosAtivos = alunos.filter(a => a.status === 'Ativo').length;
    const totalPresencas = frequencias.length;
    const mediaPresencasAluno = alunosAtivos > 0 ? totalPresencas / alunosAtivos : 0;
    
    const relatorio = `
RELATÓRIO DE DESEMPENHO DA ACADEMIA
Data: ${new Date().toLocaleDateString('pt-BR')}

RESUMO GERAL
- Total de Alunos: ${totalAlunos}
- Alunos Ativos: ${alunosAtivos}
- Taxa de Atividade: ${totalAlunos > 0 ? ((alunosAtivos / totalAlunos) * 100).toFixed(1) : 0}%
- Total de Presenças: ${totalPresencas}
- Média de Presenças por Aluno: ${mediaPresencasAluno.toFixed(1)}

MODALIDADES MAIS PROCURADAS
- Musculação: ${frequencias.filter(f => f.modalidade === 'Musculação').length} acessos
- Cardio: ${frequencias.filter(f => f.modalidade === 'Cardio').length} acessos
- Pilates: ${frequencias.filter(f => f.modalidade === 'Pilates').length} acessos

FATURAMENTO
- Receita Mensal: R$ ${matriculas.reduce((sum, m) => sum + m.valor, 0).toFixed(2)}
- Plano Médio: R$ ${(matriculas.reduce((sum, m) => sum + m.valor, 0) / matriculas.length).toFixed(2)}

Este relatório foi gerado automaticamente pelo sistema G&L Systems.
    `;
    
    alert(relatorio);
}

function gerarRelatorioPagamentos() {
    const matriculasPagas = matriculas.filter(m => m.statusPagamento === 'Pago');
    const receitaTotal = matriculasPagas.reduce((sum, m) => sum + m.valor, 0);
    const hoje = new Date();
    const vencendoEste = matriculas.filter(m => {
        const venc = new Date(m.vencimento);
        return venc.getMonth() === hoje.getMonth() && venc.getFullYear() === hoje.getFullYear();
    });
    
    let relatorio = `
RELATÓRIO DE PAGAMENTOS
Data: ${new Date().toLocaleDateString('pt-BR')}

RESUMO FINANCEIRO
- Total de Matrículas Pagas: ${matriculasPagas.length}
- Receita Total: R$ ${receitaTotal.toFixed(2)}
- Ticket Médio: R$ ${(receitaTotal / matriculasPagas.length).toFixed(2)}

VENCIMENTOS ESTE MÊS
`;

    vencendoEste.forEach(matricula => {
        const aluno = alunos.find(a => a.id === matricula.alunoId);
        relatorio += `- ${aluno?.nome}: ${new Date(matricula.vencimento).toLocaleDateString('pt-BR')} - R$ ${matricula.valor.toFixed(2)}\n`;
    });

    relatorio += '\n\nRelatório gerado automaticamente pelo sistema G&L Systems.';
    
    alert(relatorio);
}

function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'warning' ? 'alert-warning' : 
                      type === 'info' ? 'alert-info' : 'alert-primary';
    
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
{% endblock %}
