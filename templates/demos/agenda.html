{% extends "base.html" %}

{% block title %}Demo: Agenda Online - G&L Systems{% endblock %}

{% block content %}
<div class="container py-5 mt-5">
    <!-- Demo Header -->
    <div class="text-center mb-4">
        <h1><i class="fas fa-calendar-check text-success me-2"></i>Demo: Agenda Online</h1>
        <p class="lead text-muted">Sistema de agendamento para consultórios, salões e clínicas</p>
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Esta é uma demonstração funcional. Experimente agendar horários e visualizar relatórios!
        </div>
    </div>

    <!-- Dashboard Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-check fa-2x mb-2"></i>
                    <h4 id="agendamentosHoje">0</h4>
                    <p class="mb-0">Agendamentos Hoje</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h4 id="proximoHorario">--:--</h4>
                    <p class="mb-0">Próximo Atendimento</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h4 id="totalClientes">0</h4>
                    <p class="mb-0">Clientes Cadastrados</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                    <h4 id="taxaOcupacao">0%</h4>
                    <p class="mb-0">Taxa de Ocupação</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="card shadow-sm">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="agenda-tab" data-bs-toggle="tab" data-bs-target="#agenda" type="button">
                        <i class="fas fa-calendar me-2"></i>Agenda
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="clientes-tab" data-bs-toggle="tab" data-bs-target="#clientes" type="button">
                        <i class="fas fa-users me-2"></i>Clientes
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="relatorios-tab" data-bs-toggle="tab" data-bs-target="#relatorios" type="button">
                        <i class="fas fa-chart-bar me-2"></i>Relatórios
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="card-body">
            <div class="tab-content">
                <!-- Agenda Tab -->
                <div class="tab-pane fade show active" id="agenda" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Agenda do Dia</h5>
                                <div>
                                    <input type="date" id="dataAgenda" class="form-control d-inline-block" style="width: auto;">
                                    <button class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#novoAgendamentoModal">
                                        <i class="fas fa-plus me-2"></i>Novo Agendamento
                                    </button>
                                </div>
                            </div>
                            
                            <div id="agendaList" class="agenda-timeline">
                                <!-- Agenda items will be inserted here -->
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-header">
                                    <h6 class="mb-0">Horários Disponíveis</h6>
                                </div>
                                <div class="card-body">
                                    <div id="horariosDisponiveis" class="horarios-grid">
                                        <!-- Available times will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clientes Tab -->
                <div class="tab-pane fade" id="clientes" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Clientes Cadastrados</h5>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novoClienteModal">
                            <i class="fas fa-plus me-2"></i>Novo Cliente
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped" id="clientesTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>E-mail</th>
                                    <th>Último Atendimento</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Cliente data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Relatórios Tab -->
                <div class="tab-pane fade" id="relatorios" role="tabpanel">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Atendimentos por Dia da Semana</h5>
                            <canvas id="atendimentosChart" width="400" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h5>Horários Mais Procurados</h5>
                            <canvas id="horariosChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button class="btn btn-success me-2" onclick="exportarAgenda()">
                            <i class="fas fa-file-excel me-2"></i>Exportar Agenda
                        </button>
                        <button class="btn btn-info" onclick="gerarRelatorioAtendimentos()">
                            <i class="fas fa-chart-bar me-2"></i>Relatório de Atendimentos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Solutions -->
    <div class="text-center mt-4">
        <a href="{{ url_for('solutions') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar às Soluções
        </a>
    </div>
</div>

<!-- Novo Agendamento Modal -->
<div class="modal fade" id="novoAgendamentoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Agendamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="novoAgendamentoForm">
                    <div class="mb-3">
                        <label for="clienteSelect" class="form-label">Cliente</label>
                        <select class="form-select" id="clienteSelect" required>
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="agendamentoData" class="form-label">Data</label>
                        <input type="date" class="form-control" id="agendamentoData" required>
                    </div>
                    <div class="mb-3">
                        <label for="agendamentoHora" class="form-label">Horário</label>
                        <select class="form-select" id="agendamentoHora" required>
                            <option value="">Selecione um horário</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="agendamentoServico" class="form-label">Serviço</label>
                        <select class="form-select" id="agendamentoServico" required>
                            <option value="">Selecione um serviço</option>
                            <option value="Consulta">Consulta</option>
                            <option value="Retorno">Retorno</option>
                            <option value="Exame">Exame</option>
                            <option value="Tratamento">Tratamento</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="agendamentoObs" class="form-label">Observações</label>
                        <textarea class="form-control" id="agendamentoObs" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="criarAgendamento()">Agendar</button>
            </div>
        </div>
    </div>
</div>

<!-- Novo Cliente Modal -->
<div class="modal fade" id="novoClienteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="novoClienteForm">
                    <div class="mb-3">
                        <label for="clienteNome" class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="clienteNome" required>
                    </div>
                    <div class="mb-3">
                        <label for="clienteTelefone" class="form-label">Telefone</label>
                        <input type="tel" class="form-control" id="clienteTelefone" required>
                    </div>
                    <div class="mb-3">
                        <label for="clienteEmail" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="clienteEmail">
                    </div>
                    <div class="mb-3">
                        <label for="clienteNascimento" class="form-label">Data de Nascimento</label>
                        <input type="date" class="form-control" id="clienteNascimento">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="cadastrarCliente()">Cadastrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize Agenda Demo
let agendamentos = [];
let clientes = [
    {id: 1, nome: "Maria Silva", telefone: "(11) 99999-1111", email: "maria@email.com", nascimento: "1985-03-15"},
    {id: 2, nome: "João Santos", telefone: "(11) 99999-2222", email: "joao@email.com", nascimento: "1990-07-22"},
    {id: 3, nome: "Ana Costa", telefone: "(11) 99999-3333", email: "ana@email.com", nascimento: "1978-12-10"}
];
let nextClienteId = 4;
let nextAgendamentoId = 1;

const horarios = ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00'];

document.addEventListener('DOMContentLoaded', function() {
    // Set today's date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dataAgenda').value = today;
    document.getElementById('agendamentoData').value = today;
    
    updateDashboard();
    updateAgendaView();
    updateClientesTable();
    updateClienteSelect();
    updateHorariosDisponiveis();
    updateHorarioSelect();
    initCharts();
    
    // Add event listeners
    document.getElementById('dataAgenda').addEventListener('change', updateAgendaView);
});

function updateDashboard() {
    const hoje = new Date().toISOString().split('T')[0];
    const agendamentosHoje = agendamentos.filter(a => a.data === hoje);
    
    document.getElementById('agendamentosHoje').textContent = agendamentosHoje.length;
    document.getElementById('totalClientes').textContent = clientes.length;
    
    // Próximo horário
    const proximoAgendamento = agendamentosHoje.find(a => a.hora > new Date().toTimeString().slice(0,5));
    document.getElementById('proximoHorario').textContent = proximoAgendamento ? proximoAgendamento.hora : '--:--';
    
    // Taxa de ocupação
    const totalSlots = horarios.length;
    const ocupados = agendamentosHoje.length;
    const taxaOcupacao = totalSlots > 0 ? Math.round((ocupados / totalSlots) * 100) : 0;
    document.getElementById('taxaOcupacao').textContent = `${taxaOcupacao}%`;
}

function updateAgendaView() {
    const dataSelecionada = document.getElementById('dataAgenda').value;
    const agendamentosDoDia = agendamentos.filter(a => a.data === dataSelecionada);
    const container = document.getElementById('agendaList');
    
    if (agendamentosDoDia.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info text-center">
                <i class="fas fa-calendar-times fa-2x mb-3"></i>
                <p class="mb-0">Nenhum agendamento para esta data.</p>
            </div>
        `;
        return;
    }
    
    agendamentosDoDia.sort((a, b) => a.hora.localeCompare(b.hora));
    
    let html = '';
    agendamentosDoDia.forEach(agendamento => {
        const cliente = clientes.find(c => c.id === agendamento.clienteId);
        html += `
            <div class="agenda-item p-3 mb-2 border-start border-3 border-success bg-light">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${agendamento.hora} - ${cliente?.nome || 'Cliente não encontrado'}</h6>
                        <p class="mb-1"><strong>Serviço:</strong> ${agendamento.servico}</p>
                        <p class="mb-1"><strong>Telefone:</strong> ${cliente?.telefone || ''}</p>
                        ${agendamento.observacoes ? `<p class="mb-0"><strong>Obs:</strong> ${agendamento.observacoes}</p>` : ''}
                    </div>
                    <div>
                        <span class="badge bg-success">Agendado</span>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="cancelarAgendamento(${agendamento.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    updateHorariosDisponiveis();
}

function updateHorariosDisponiveis() {
    const dataSelecionada = document.getElementById('dataAgenda').value;
    const agendamentosDoDia = agendamentos.filter(a => a.data === dataSelecionada);
    const horariosOcupados = agendamentosDoDia.map(a => a.hora);
    const container = document.getElementById('horariosDisponiveis');
    
    let html = '';
    horarios.forEach(horario => {
        const ocupado = horariosOcupados.includes(horario);
        html += `
            <button class="btn btn-sm ${ocupado ? 'btn-secondary' : 'btn-outline-success'} mb-1 me-1" 
                    ${ocupado ? 'disabled' : `onclick="selecionarHorario('${horario}')"`}>
                ${horario}
            </button>
        `;
    });
    
    container.innerHTML = html;
}

function updateClientesTable() {
    const tbody = document.querySelector('#clientesTable tbody');
    tbody.innerHTML = '';
    
    clientes.forEach(cliente => {
        const ultimoAtendimento = agendamentos
            .filter(a => a.clienteId === cliente.id)
            .sort((a, b) => new Date(b.data + ' ' + b.hora) - new Date(a.data + ' ' + a.hora))[0];
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${cliente.id}</td>
            <td>${cliente.nome}</td>
            <td>${cliente.telefone}</td>
            <td>${cliente.email || '-'}</td>
            <td>${ultimoAtendimento ? ultimoAtendimento.data : 'Nunca'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editarCliente(${cliente.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="novoAgendamentoCliente(${cliente.id})">
                    <i class="fas fa-calendar-plus"></i>
                </button>
            </td>
        `;
    });
}

function updateClienteSelect() {
    const select = document.getElementById('clienteSelect');
    select.innerHTML = '<option value="">Selecione um cliente</option>';
    
    clientes.forEach(cliente => {
        const option = document.createElement('option');
        option.value = cliente.id;
        option.textContent = cliente.nome;
        select.appendChild(option);
    });
}

function updateHorarioSelect() {
    const select = document.getElementById('agendamentoHora');
    select.innerHTML = '<option value="">Selecione um horário</option>';
    
    horarios.forEach(horario => {
        const option = document.createElement('option');
        option.value = horario;
        option.textContent = horario;
        select.appendChild(option);
    });
}

function selecionarHorario(horario) {
    document.getElementById('agendamentoHora').value = horario;
    const modal = new bootstrap.Modal(document.getElementById('novoAgendamentoModal'));
    modal.show();
}

function cadastrarCliente() {
    const nome = document.getElementById('clienteNome').value;
    const telefone = document.getElementById('clienteTelefone').value;
    const email = document.getElementById('clienteEmail').value;
    const nascimento = document.getElementById('clienteNascimento').value;
    
    const novoCliente = {
        id: nextClienteId++,
        nome: nome,
        telefone: telefone,
        email: email,
        nascimento: nascimento
    };
    
    clientes.push(novoCliente);
    updateClientesTable();
    updateClienteSelect();
    updateDashboard();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('novoClienteModal'));
    modal.hide();
    document.getElementById('novoClienteForm').reset();
    
    showNotification('Cliente cadastrado com sucesso!', 'success');
}

function criarAgendamento() {
    const clienteId = parseInt(document.getElementById('clienteSelect').value);
    const data = document.getElementById('agendamentoData').value;
    const hora = document.getElementById('agendamentoHora').value;
    const servico = document.getElementById('agendamentoServico').value;
    const observacoes = document.getElementById('agendamentoObs').value;
    
    // Check for conflicts
    const conflito = agendamentos.find(a => a.data === data && a.hora === hora);
    if (conflito) {
        showNotification('Já existe um agendamento para este horário!', 'warning');
        return;
    }
    
    const novoAgendamento = {
        id: nextAgendamentoId++,
        clienteId: clienteId,
        data: data,
        hora: hora,
        servico: servico,
        observacoes: observacoes,
        status: 'Agendado'
    };
    
    agendamentos.push(novoAgendamento);
    updateDashboard();
    updateAgendaView();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('novoAgendamentoModal'));
    modal.hide();
    document.getElementById('novoAgendamentoForm').reset();
    
    showNotification('Agendamento criado com sucesso!', 'success');
}

function cancelarAgendamento(id) {
    if (confirm('Tem certeza que deseja cancelar este agendamento?')) {
        agendamentos = agendamentos.filter(a => a.id !== id);
        updateDashboard();
        updateAgendaView();
        showNotification('Agendamento cancelado!', 'info');
    }
}

function novoAgendamentoCliente(clienteId) {
    document.getElementById('clienteSelect').value = clienteId;
    const modal = new bootstrap.Modal(document.getElementById('novoAgendamentoModal'));
    modal.show();
}

function editarCliente(id) {
    showNotification('Funcionalidade de edição em desenvolvimento!', 'info');
}

function initCharts() {
    // Atendimentos por dia da semana
    const ctxAtendimentos = document.getElementById('atendimentosChart').getContext('2d');
    const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
    const dadosAtendimentos = [0, 8, 12, 10, 15, 20, 5]; // Sample data
    
    new Chart(ctxAtendimentos, {
        type: 'bar',
        data: {
            labels: diasSemana,
            datasets: [{
                label: 'Atendimentos',
                data: dadosAtendimentos,
                backgroundColor: '#28a745'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Horários mais procurados
    const ctxHorarios = document.getElementById('horariosChart').getContext('2d');
    const horariosPopulares = ['09:00', '10:00', '14:00', '15:00', '16:00'];
    const dadosHorarios = [15, 20, 25, 18, 12];
    
    new Chart(ctxHorarios, {
        type: 'doughnut',
        data: {
            labels: horariosPopulares,
            datasets: [{
                data: dadosHorarios,
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
            }]
        },
        options: {
            responsive: true
        }
    });
}

function exportarAgenda() {
    const csv = 'Data,Hora,Cliente,Serviço,Telefone,Observações\n' +
        agendamentos.map(a => {
            const cliente = clientes.find(c => c.id === a.clienteId);
            return `${a.data},${a.hora},${cliente?.nome},${a.servico},${cliente?.telefone},"${a.observacoes}"`;
        }).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'agenda.csv';
    link.click();
    
    showNotification('Agenda exportada com sucesso!', 'success');
}

function gerarRelatorioAtendimentos() {
    const totalAgendamentos = agendamentos.length;
    const clientesAtendidos = new Set(agendamentos.map(a => a.clienteId)).size;
    const taxaOcupacaoMedia = 75; // Sample data
    
    alert(`
RELATÓRIO DE ATENDIMENTOS

Total de Agendamentos: ${totalAgendamentos}
Clientes Únicos Atendidos: ${clientesAtendidos}
Taxa de Ocupação Média: ${taxaOcupacaoMedia}%
Total de Clientes Cadastrados: ${clientes.length}

Este relatório foi gerado automaticamente pelo sistema G&L Systems.
    `);
}

function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'warning' ? 'alert-warning' : 
                      type === 'info' ? 'alert-info' : 'alert-primary';
    
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>

<style>
.agenda-item {
    border-radius: 8px;
    transition: all 0.3s ease;
}

.agenda-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.horarios-grid button {
    width: 60px;
    font-size: 0.8rem;
}
</style>
{% endblock %}
